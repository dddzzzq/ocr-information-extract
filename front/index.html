<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园海报信息提取系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* (您的 <style> 内容保持不变) */
        body { font-family: 'Inter', 'Microsoft YaHei', sans-serif; }
        .spinner { border-top-color: transparent; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .crop-container { width: 100%; height: 400px; background-color: #f3f4f6; }
        .crop-container img { display: block; max-width: 100%; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 50; padding: 1.5rem; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .detail-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 640px) { .detail-grid { grid-template-columns: 1fr 2fr; } }
        .detail-grid strong { color: #4B5563; font-weight: 500; }
        .detail-grid p { color: #1F2937; }
        .raw-text-block { background-color: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 0.375rem; padding: 0.75rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; font-size: 0.875rem; color: #374151; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        
        <nav class="bg-white rounded-2xl shadow-lg p-4 mb-6 flex justify-between items-center">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-900">
                校园海报信息系统
            </h1>
            <div class="space-x-2">
                <button @click="currentPage = 'home'" :class="navButtonClass('home')">首页</button>
                <button @click="currentPage = 'upload'" :class="navButtonClass('upload')">上传新海报</button>
                <button @click="currentPage = 'view'" :class="navButtonClass('view')">查看历史</button>
            </div>
        </nav>

        <main class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 min-h-[600px]">
            
            <div v-if="currentPage === 'home'" class="space-y-6">
                <header class="text-center mb-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">欢迎使用</h1>
                    <p class="text-gray-500 mt-2">校园海报信息提取与管理系统</p>
                </header>
                <div class="text-center">
                    <img src="https://placehold.co/600x300/3B82F6/FFFFFF?text=Poster+System" alt="系统示意图" class="w-full max-w-lg mx-auto rounded-lg shadow-md">
                </div>
                <div class="space-y-4 text-center">
                    <p class="text-lg text-gray-700">
                        本系统利用 OCR 和 LLM 技术，帮助您快速从海报图片中提取关键信息。
                    </p>
                    <div class="flex justify-center space-x-4">
                        <button @click="currentPage = 'upload'" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                            立即上传
                        </button>
                        <button @click="currentPage = 'view'" class="bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                            查看活动
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentPage === 'upload'" class="space-y-6">
                <header class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">上传海报</h1>
                    <p class="text-gray-500 mt-2">支持 JPG, PNG 等格式。上传后可进行裁剪。</p>
                </header>
                <div v-if="!imagePreviewUrl" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-50 transition-all" @click="triggerFileUpload">
                    <input type="file" ref="fileInput" @change="handleFileChange" accept="image/*" class="hidden">
                    <svg class="w-12 h-12 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.34 3 3 0 013.75 5.613" />
                    </svg>
                    <p class="text-gray-600 mt-3">点击此处或拖拽图片到这里上传</p>
                </div>
                <div v-if="imagePreviewUrl" class="space-y-4">
                    <!-- <h2 class="text-xl font-semibold text-center">2. (可选) 框选关键区域</h2> -->
                    <div class="crop-container rounded-lg overflow-hidden shadow">
                        <img id="crop-image" :src="imagePreviewUrl" alt="图片预览">
                    </div>
                    <button @click.stop="removeImage" class="w-full text-red-600 font-medium py-2 rounded-lg hover:bg-red-50 transition-colors">
                        移除图片
                    </button>
                </div>
                <div class="text-center pt-4">
                    <button @click="extractInformation" :disabled="!selectedFile || isLoading"
                            class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all flex items-center justify-center mx-auto">
                        <div v-if="isLoading" class="spinner border-2 border-white rounded-full mr-2"></div>
                        <span>{{ isLoading ? '正在提取...' : '开始提取信息' }}</span>
                    </button>
                </div>
                <div v-if="error" class="mt-8 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">错误：</strong>
                    <span class="block sm:inline">{{ error }}</span>
                </div>


                <div v-if="extractionResult" class="mt-8 pt-6 border-t border-gray-200">
                    <h2 class="text-2xl font-bold text-center mb-6">最新提取结果</h2>
                    <div class="bg-gray-50 rounded-lg p-6 space-y-4 shadow-inner">
                        
                        <div v-if="extractionResult.title && extractionResult.title !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <strong class="sm:col-span-1 text-gray-600">活动主题</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.title }}</p>
                        </div>
                        
                        <div v-if="extractionResult.event_type && extractionResult.event_type !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">活动类型</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.event_type }}</p>
                        </div>
                        <div v-if="extractionResult.speaker && extractionResult.speaker !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">主讲人</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.speaker }}</p>
                        </div>
                        
                        <div v-if="extractionResult.date && extractionResult.date !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">日期</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.date }}</p>
                        </div>
                        <div v-if="extractionResult.time && extractionResult.time !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">时间</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.time }}</p>
                        </div>
                        <div v-if="extractionResult.location && extractionResult.location !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">地点</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.location }}</p>
                        </div>
                        
                        <div v-if="extractionResult.target_audience && extractionResult.target_audience !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">面向对象</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.target_audience }}</p>
                        </div>

                        <div v-if="extractionResult.organizer && extractionResult.organizer !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">主办方</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.organizer }}</p>
                        </div>
                        
                        <div v-if="extractionResult.contact_info && extractionResult.contact_info !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">联系方式</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.contact_info }}</p>
                        </div>
                        <div v-if="extractionResult.registration_info && extractionResult.registration_info !== 'None'" class="grid grid-cols-1 sm:grid-cols-3 gap-4 border-t border-gray-200 pt-4">
                            <strong class="sm:col-span-1 text-gray-600">报名信息</strong>
                            <p class="sm:col-span-2 text-gray-800">{{ extractionResult.registration_info }}</p>
                        </div>

                        <div v-if="extractionResult.summary && extractionResult.summary !== 'None'" class="flex flex-col gap-4 border-t border-gray-200 pt-4">
                            <strong class="text-gray-600">内容摘要</strong>
                            <p class="text-gray-800 leading-relaxed">{{ extractionResult.summary }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentPage === 'view'" class="space-y-6">
                <header class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">提取历史与审核</h1>
                    <p class="text-gray-500 mt-2">查看、搜索、确认或删除已提取的活动</p>
                </header>

                <div class="flex space-x-2">
                    <input type="text" v-model="searchQuery" @keyup.enter="searchHistory" placeholder="按活动标题搜索..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button @click="searchHistory" :disabled="searchLoading" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center">
                        <div v-if="searchLoading" class="spinner border-2 border-white rounded-full mr-2"></div>
                        <span>搜索</span>
                    </button>
                </div>

                <div class="flex justify-center space-x-2 bg-gray-100 p-1 rounded-lg">
                    <button @click="filterStatus = 'all'" :class="filterButtonClass('all')">全部</button>
                    <button @click="filterStatus = 'pending'" :class="filterButtonClass('pending')">待审核</button>
                    <button @click="filterStatus = 'approved'" :class="filterButtonClass('approved')">已确认</button>
                </div>

                <div class="space-y-4">
                    <div v-if="historyLoading" class="text-center py-8 text-gray-500">
                        <div class="spinner border-4 border-gray-300 rounded-full mx-auto w-12 h-12"></div>
                        <p class="mt-2">正在加载数据...</p>
                    </div>
                    <div v-else-if="filteredHistoryList.length === 0" class="text-center py-8 text-gray-500">
                        <svg class="w-16 h-16 mx-auto text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75v-2.625a3.375 3.375 0 00-3.375-3.375H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 003.375-3.375m0 0h3.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125H8.25M3.75 9v.001z" />
                        </svg>
                        <p class="mt-2">未找到符合条件的项目</p>
                        <p v-if="searchQuery" class="text-sm text-gray-400">请尝试清除搜索词</p>
                    </div>
                    
                    <div v-for="item in filteredHistoryList" :key="item.id" class="bg-white border rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 cursor-pointer hover:bg-gray-50 -m-4 p-4 rounded-l-lg transition-colors" @click="showDetails(item)">
                                <h3 class="font-bold text-lg text-gray-800">{{ item.title }}</h3>
                                <p class="text-sm text-gray-500">
                                    <span v-if="item.date && item.date !== 'None'">{{ item.date }}</span>
                                    <span v-if="(item.date && item.date !== 'None') && (item.location && item.location !== 'None')"> | </span>
                                    <span v-if="item.location && item.location !== 'None'">{{ item.location }}</span>
                                </p>
                            </div>
                            <div class="ml-4 flex-shrink-0">
                                <span v-if="item.status === 'pending'" class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                    待审核
                                </span>
                                <span v-else class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                    已确认
                                </span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex justify-end space-x-2">
                            <button v-if="item.status === 'pending'" @click="confirmPoster(item.id)" class="px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">
                                确认
                            </button>
                            <button @click="deletePoster(item.id)" class="px-3 py-1 text-sm font-medium rounded-md bg-red-100 text-red-700 hover:bg-red-200">
                                删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    

        <div v-if="selectedHistoryItem" class="modal-overlay" @click.self="closeDetails">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">活动详情</h2>
                    <button @click="closeDetails" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">

                    <div v-if="selectedHistoryItem.image_url" class="border-b border-gray-200 pb-4">
                        <img :src="getFullImageUrl(selectedHistoryItem.image_url)" alt="海报图片" class="w-full h-auto max-h-[400px] object-contain rounded-lg bg-gray-100">
                    </div>
                    
                    <div v-if="selectedHistoryItem.title && selectedHistoryItem.title !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>活动主题</strong>
                        <p>{{ selectedHistoryItem.title }}</p>
                    </div>
                    
                    <div v-if="selectedHistoryItem.event_type && selectedHistoryItem.event_type !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>活动类型</strong>
                        <p>{{ selectedHistoryItem.event_type }}</p>
                    </div>
                    <div v-if="selectedHistoryItem.speaker && selectedHistoryItem.speaker !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>主讲人</strong>
                        <p>{{ selectedHistoryItem.speaker }}</p>
                    </div>
                    
                    <div v-if="selectedHistoryItem.date && selectedHistoryItem.date !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>日期</strong>
                        <p>{{ selectedHistoryItem.date }}</p>
                    </div>
                    <div v-if="selectedHistoryItem.time && selectedHistoryItem.time !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>时间</strong>
                        <p>{{ selectedHistoryItem.time }}</p>
                    </div>
                    <div v-if="selectedHistoryItem.location && selectedHistoryItem.location !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>地点</strong>
                        <p>{{ selectedHistoryItem.location }}</p>
                    </div>
                    
                    <div v-if="selectedHistoryItem.target_audience && selectedHistoryItem.target_audience !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>面向对象</strong>
                        <p>{{ selectedHistoryItem.target_audience }}</p>
                    </div>

                    <div v-if="selectedHistoryItem.organizer && selectedHistoryItem.organizer !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>主办方</strong>
                        <p>{{ selectedHistoryItem.organizer }}</p>
                    </div>
                    
                    <div v-if="selectedHistoryItem.contact_info && selectedHistoryItem.contact_info !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>联系方式</strong>
                        <p>{{ selectedHistoryItem.contact_info }}</p>
                    </div>
                    <div v-if="selectedHistoryItem.registration_info && selectedHistoryItem.registration_info !== 'None'" class="detail-grid border-t border-gray-200 pt-4">
                        <strong>报名信息</strong>
                        <p>{{ selectedHistoryItem.registration_info }}</p>
                    </div>

                    <div v-if="selectedHistoryItem.summary && selectedHistoryItem.summary !== 'None'" class="flex flex-col gap-2 border-t border-gray-200 pt-4">
                        <strong>内容摘要</strong>
                        <p class="leading-relaxed">{{ selectedHistoryItem.summary }}</p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- 1. 全局状态 (Global State) ---
                const currentPage = ref('home'); // 'home', 'upload', 'view'
                const error = ref(''); // 全局错误信息
                const backendHost = 'http://127.0.0.1:8000'; // (新增) 后端主机地址
                const backendApiUrl = `${backendHost}/api/v1`; // API 路径

                // --- 2. 上传页面状态 (Upload Page) ---
                const fileInput = ref(null);
                const selectedFile = ref(null);
                const imagePreviewUrl = ref('');
                const isLoading = ref(false); // 提取按钮
                const extractionResult = ref(null); // 最新提取结果
                const cropperInstance = ref(null);

                // --- 3. 查看页面状态 (View Page) ---
                const historyList = ref([]); // 数据库返回的原始列表
                const historyLoading = ref(true); // 历史记录加载
                const filterStatus = ref('all'); // 'all', 'pending', 'approved'
                const searchQuery = ref('');
                const searchLoading = ref(false);
                const selectedHistoryItem = ref(null); // 弹窗

                // --- (新增) 辅助函数：获取完整的图片 URL ---
                const getFullImageUrl = (partialUrl) => {
                    // partialUrl 可能是 /static/uploads/image.jpg
                    // 我们需要将其转换为 http://127.0.0.1:8000/static/uploads/image.jpg
                    if (!partialUrl) return '';
                    return `${backendHost}${partialUrl}`;
                };

                // --- 4. 导航栏 (Navigation) ---
                const navButtonClass = (pageName) => {
                    const baseClass = 'font-medium py-2 px-3 rounded-lg transition-colors';
                    if (currentPage.value === pageName) {
                        return `${baseClass} bg-blue-100 text-blue-700`;
                    }
                    return `${baseClass} text-gray-600 hover:bg-gray-100`;
                };

                // --- 5. 筛选按钮 (Filter Buttons) ---
                const filterButtonClass = (statusName) => {
                    const baseClass = 'flex-1 font-medium py-2 px-3 rounded-md transition-colors text-sm';
                    if (filterStatus.value === statusName) {
                        return `${baseClass} bg-white text-blue-700 shadow-sm`;
                    }
                    return `${baseClass} text-gray-600 hover:bg-gray-200`;
                };

                // --- 6. 上传与裁剪 (Upload & Crop) ---
                const triggerFileUpload = () => {
                    fileInput.value.click();
                };

                const handleFileChange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        selectedFile.value = file;
                        if (imagePreviewUrl.value) {
                            URL.revokeObjectURL(imagePreviewUrl.value);
                        }
                        imagePreviewUrl.value = URL.createObjectURL(file);
                        extractionResult.value = null;
                        error.value = '';
                    }
                };
                
                const removeImage = () => {
                    selectedFile.value = null;
                    if (imagePreviewUrl.value) {
                        URL.revokeObjectURL(imagePreviewUrl.value);
                    }
                    imagePreviewUrl.value = '';
                    fileInput.value.value = ''; // 重置 input
                    extractionResult.value = null;
                };

                const initCropper = () => {
                    if (cropperInstance.value) {
                        cropperInstance.value.destroy();
                    }
                    const image = document.getElementById('crop-image');
                    if (image) {
                        cropperInstance.value = new Cropper(image, {
                            viewMode: 1,
                            autoCropArea: 0.9,
                            aspectRatio: NaN, // 自由裁剪
                            background: false,
                        });
                    }
                };

                // 监视 imagePreviewUrl 变化，以初始化或销毁 Cropper
                watch(imagePreviewUrl, (newUrl) => {
                    if (newUrl) {
                        // 等待 DOM 更新
                        nextTick(() => {
                            initCropper();
                        });
                    } else {
                        if (cropperInstance.value) {
                            cropperInstance.value.destroy();
                            cropperInstance.value = null;
                        }
                    }
                });

                // --- 7. 提取 (Extraction) ---
                const extractInformation = async () => {
                    if (!selectedFile.value) {
                        error.value = '请先选择一张图片。';
                        return;
                    }
                    
                    if (!cropperInstance.value) {
                        console.warn("Cropper 实例未就绪，将使用原图");
                        error.value = '图片裁剪器未准备好，请稍等或重新上传';
                        return;
                    }

                    isLoading.value = true;
                    error.value = '';
                    extractionResult.value = null;

                    try {
                        const croppedCanvas = cropperInstance.value.getCroppedCanvas({
                            fillColor: '#ffffff'
                        });
                        
                        const blob = await new Promise(resolve => croppedCanvas.toBlob(resolve, 'image/jpeg', 0.9)); 
                        
                        const formData = new FormData();
                        const originalName = selectedFile.value.name.replace(/\..+$/, '');
                        formData.append('file', blob, `${originalName}.jpg`);

                        const response = await fetch(`${backendApiUrl}/extract`, {
                            method: 'POST',
                            body: formData,
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ detail: '服务器响应错误' }));
                            throw new Error(errorData.detail || `HTTP 错误! 状态: ${response.status}`);
                        }

                        const data = await response.json();
                        extractionResult.value = data; 
                        
                        await fetchHistory(); 
                        
                        currentPage.value = 'view';
                        filterStatus.value = 'pending';

                    } catch (e) {
                        console.error('提取信息时出错:', e);
                        error.value = `请求失败: ${e.message}。请检查后端服务。`;
                    } finally {
                        isLoading.value = false;
                    }
                };

                // --- 8. 历史记录 (History & CRUD) ---
                const fetchHistory = async (query = '') => {
                    historyLoading.value = true;
                    try {
                        const response = await fetch(`${backendApiUrl}/posters/?search=${encodeURIComponent(query)}`);
                        if (!response.ok) throw new Error('获取历史记录失败');
                        const data = await response.json();
                        historyList.value = data;
                    } catch (e) {
                        error.value = `获取历史失败: ${e.message}`;
                        historyList.value = []; 
                    } finally {
                        historyLoading.value = false;
                    }
                };
                
                const searchHistory = () => {
                    searchLoading.value = true;
                    fetchHistory(searchQuery.value).finally(() => {
                        searchLoading.value = false;
                    });
                };

                const filteredHistoryList = computed(() => {
                    if (filterStatus.value === 'all') {
                        return historyList.value;
                    }
                    return historyList.value.filter(item => item.status === filterStatus.value);
                });

                const confirmPoster = async (id) => {
                    try {
                        const response = await fetch(`${backendApiUrl}/posters/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'approved' })
                        });
                        if (!response.ok) throw new Error('确认失败');
                        
                        const index = historyList.value.findIndex(item => item.id === id);
                        if (index !== -1) {
                            historyList.value[index].status = 'approved';
                        }
                    } catch (e) {
                        error.value = `确认失败: ${e.message}`;
                    }
                };

                const deletePoster = async (id) => {
                    if (!confirm("确定要删除这条记录吗？")) return;
                    
                    try {
                        const response = await fetch(`${backendApiUrl}/posters/${id}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) throw new Error('删除失败');
                        
                        historyList.value = historyList.value.filter(item => item.id !== id);
                        
                        if (selectedHistoryItem.value && selectedHistoryItem.value.id === id) {
                            closeDetails();
                        }
                    } catch (e) {
                        error.value = `删除失败: ${e.message}`;
                    }
                };

                // --- 9. 详情弹窗 (Modal) ---
                const showDetails = (item) => {
                    selectedHistoryItem.value = item;
                };
                const closeDetails = () => {
                    selectedHistoryItem.value = null;
                };
                
                // --- 10. 初始化 (Initialization) ---
                onMounted(() => {
                    fetchHistory();
                });

                return {
                    // 状态
                    currentPage,
                    error,
                    fileInput,
                    selectedFile,
                    imagePreviewUrl,
                    isLoading,
                    extractionResult,
                    cropperInstance,
                    historyList,
                    historyLoading,
                    filterStatus,
                    searchQuery,
                    searchLoading,
                    selectedHistoryItem,
                    // 计算属性
                    filteredHistoryList,
                    // 方法
                    navButtonClass,
                    filterButtonClass,
                    triggerFileUpload,
                    handleFileChange,
                    removeImage,
                    extractInformation,
                    fetchHistory,
                    searchHistory,
                    confirmPoster,
                    deletePoster,
                    showDetails,
                    closeDetails,
                    getFullImageUrl 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>